---
import Head from "@components/_head.astro";
import Footer from "@components/dashboard/_footer.astro";
import Topbar from "@components/dashboard/_topbar.astro";
import Sidenav from "@components/dashboard/_sidenav.astro";
import Scripts from "@components/_scripts.astro";

const title = "QNAP | Monitoring System";
const path = "../../../dist";
const mainPage = "dashboard";
const page = "modify-merchants";

// fetch all merchants from API
let merchants = [];
try {
  const apiBaseUrl = import.meta.env.PUBLIC_API_BASE;
  const response = await fetch(`${apiBaseUrl}/get_merchants.php`);
  const data = await response.json();
  merchants = data.records || [];
} catch (error) {
  console.error("Error:", error);
}

// calculate total pages and set max elements per page for table
const itemsPerPage = 10;
const totalPages = Math.ceil(merchants.length / itemsPerPage);

const paginationArray = [];
for (let i = 1; i <= totalPages; i++) {
  paginationArray.push(i);
}
---

<!doctype html>
<html lang="en">
  <!--begin::Head-->
  <head>
    <Head title={title} path={path} />
  </head>
  <!--end::Head-->
  <!--begin::Body-->
  <body class="layout-fixed sidebar-expand-lg bg-body-tertiary">
    <!--begin::App Wrapper-->
    <div class="app-wrapper">
      <Topbar path={path} />
      <Sidenav path={path} mainPage={mainPage} page={page} />
      <!--begin::App Main-->
      <main class="app-main">
        <!--begin::App Content Header-->
        <div class="app-content-header">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Row-->
            <div class="row">
              <div class="col-sm-6">
                <h3 class="mb-0">Modify merchants</h3>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-end">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item">Modify Items</li>
                  <li class="breadcrumb-item active" aria-current="page">
                    merchants
                  </li>
                </ol>
              </div>
            </div>
            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content Header-->
        <!--begin::App Content-->
        <div class="app-content">
          <!--begin::Container-->
          <div class="container-fluid">
            <!--begin::Card-->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">merchants List</h3>
                <div class="ms-auto">
                  <div class="input-group input-group-sm" style="width: 250px;">
                    <input type="text" id="product-search" class="form-control" placeholder="Search merchants...">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-bordered table-striped" id="merchants-table">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>Merchant Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      {merchants.length > 0 ? (
                        merchants.map((merchant: any, index: number) => (
                          <tr class="table-row" data-page={Math.floor(index / itemsPerPage) + 1} data-product={JSON.stringify(merchant)}>
                            <td>{merchant.merchant_id}</td>
                            <td>{merchant.merchant_name}</td>
                            <td>{merchant.email}</td>
                            <td>{merchant.phone}</td>
                            <td>{merchant.address}</td>
                            <td>
                              <span class={`badge ${merchant.merchant_status === 'active' ? 'bg-success' : 'bg-danger'}`}>
                                {merchant.merchant_status}
                              </span>
                            </td>
                            <td>
                              <button class="btn btn-primary btn-sm edit-btn" data-merchant-id={merchant.merchant_id}>
                                <i class="bi bi-pencil-square"></i> Edit
                              </button>
                            </td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colspan="8" class="text-center">No merchants found</td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card-footer">
                <nav aria-label="Page navigation">
                  <ul class="pagination justify-content-center" id="pagination">
                    <li class="page-item page-prev disabled">
                      <a class="page-link" href="#" tabindex="-1">Previous</a>
                    </li>
                    {paginationArray.map(pageNum => (
                      <li class={`page-item page-number ${pageNum === 1 ? 'active' : ''}`} data-page={pageNum}>
                        <a class="page-link" href="#">{pageNum}</a>
                      </li>
                    ))}
                    <li class={`page-item page-next ${totalPages <= 1 ? 'disabled' : ''}`}>
                      <a class="page-link" href="#">Next</a>
                    </li>
                  </ul>
                </nav>
              </div>
            </div>
            <!--end::Card-->
          </div>
          <!--end::Container-->
        </div>
        <!--end::App Content-->
      </main>
      <!--end::App Main-->
      <Footer />
    </div>
    <!--end::App Wrapper-->
    
    <!-- Edit Merchant Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editProductModalLabel">Edit Merchant</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editProductForm">
              <input type="hidden" id="merchant_id" name="merchant_id">
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="merchant_name" class="form-label">Merchant Name</label>
                  <input type="text" class="form-control" id="merchant_name" name="merchant_name" required>
                </div>
                <div class="col-md-6">
                  <label for="email" class="form-label">Email</label>
                  <input type="email" class="form-control" id="email" name="email" required>
                </div>
              </div>
              
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="phone" class="form-label">Phone</label>
                  <input type="text" class="form-control" id="phone" name="phone" required>
                </div>
                <div class="col-md-6">
                  <label for="merchant_status" class="form-label">Status</label>
                  <select class="form-select" id="merchant_status" name="merchant_status" required>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
              </div>
              
              <div class="mb-3">
                <label for="address" class="form-label">Address</label>
                <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <p class="text-muted mb-0">Created: <span id="created_at"></span></p>
                </div>
                <div class="col-md-6">
                  <p class="text-muted mb-0">Last Updated: <span id="updated_at"></span></p>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveProductBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Success Alert Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="alertTitle">Success</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="alertMessage">Merchant updated successfully!</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
          </div>
        </div>
      </div>
    </div>
    
    <!--begin::Script-->
    <Scripts path={path} />

    <script is:inline define:vars={{ totalPages, itemsPerPage }}>
      document.addEventListener('DOMContentLoaded', function() {
        let currentPage = 1;
        const apiBaseUrl = window.PUBLIC_API_BASE || '';
        
        // Pagination functionality
        function showPage(page) {
          document.querySelectorAll('#merchants-table .table-row').forEach(row => {
            row.style.display = 'none';
          });

          document.querySelectorAll(`#merchants-table .table-row[data-page="${page}"]`).forEach(row => {
            row.style.display = '';
          });

          document.querySelectorAll('#pagination .page-number').forEach(item => {
            item.classList.remove('active');
          });
          document.querySelector(`#pagination .page-number[data-page="${page}"]`)?.classList.add('active');
          document.querySelector('.page-prev').classList.toggle('disabled', page === 1);
          document.querySelector('.page-next').classList.toggle('disabled', page === totalPages);
          
          currentPage = page;
        }

        // Show first page at first glance
        showPage(1);

        document.querySelectorAll('#pagination .page-number').forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();
            const page = parseInt(this.getAttribute('data-page'));
            showPage(page);
          });
        });

        document.querySelector('.page-prev')?.addEventListener('click', function(e) {
          e.preventDefault();
          if (currentPage > 1) {
            showPage(currentPage - 1);
          }
        });

        document.querySelector('.page-next')?.addEventListener('click', function(e) {
          e.preventDefault();
          if (currentPage < totalPages) {
            showPage(currentPage + 1);
          }
        });
        
        // Merchant search functionality
        const merchantSearch = document.getElementById('product-search');
        merchantSearch?.addEventListener('input', function() {
          const searchText = this.value.toLowerCase();
          let visibleItems = 0;
          
          document.querySelectorAll('#merchants-table .table-row').forEach(row => {
            const merchantName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            const merchantEmail = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
            
            if (merchantName.includes(searchText) || merchantEmail.includes(searchText)) {
              row.style.display = '';
              visibleItems++;
            } else {
              row.style.display = 'none';
            }
          });
          
          // Show "no results" message if needed
          if (visibleItems === 0) {
            const noResultsRow = document.createElement('tr');
            noResultsRow.id = 'no-results-row';
            noResultsRow.innerHTML = '<td colspan="8" class="text-center">No matching merchants found</td>';
            
            const existingNoResults = document.getElementById('no-results-row');
            if (!existingNoResults) {
              document.querySelector('#merchants-table tbody').appendChild(noResultsRow);
            }
          } else {
            const existingNoResults = document.getElementById('no-results-row');
            if (existingNoResults) {
              existingNoResults.remove();
            }
          }
        });

        // Edit button click handler
        document.querySelectorAll('.edit-btn').forEach(button => {
          button.addEventListener('click', function() {
            const merchantRow = this.closest('tr');
            const merchantData = JSON.parse(merchantRow.dataset.product);
            
            // Fill the edit form with merchant data
            document.getElementById('merchant_id').value = merchantData.merchant_id;
            document.getElementById('merchant_name').value = merchantData.merchant_name;
            document.getElementById('email').value = merchantData.email;
            document.getElementById('phone').value = merchantData.phone;
            document.getElementById('address').value = merchantData.address;
            document.getElementById('merchant_status').value = merchantData.merchant_status;
            document.getElementById('created_at').textContent = merchantData.created_at;
            document.getElementById('updated_at').textContent = merchantData.updated_at;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editProductModal'));
            editModal.show();
          });
        });
        
        // Save button click handler
        document.getElementById('saveProductBtn')?.addEventListener('click', async function() {
          const form = document.getElementById('editProductForm');
          
          // Basic form validation
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }
          
          // Get form data
          const formData = {
            merchant_id: document.getElementById('merchant_id').value,
            merchant_name: document.getElementById('merchant_name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            merchant_status: document.getElementById('merchant_status').value
          };
          
          try {
            // Show loading state
            const saveBtn = document.getElementById('saveProductBtn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            
            // Send request to update merchant
            const response = await fetch(`${apiBaseUrl}/update_merchant.php`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            // Reset button state
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            
            // Close the edit modal
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            
            // Show success message
            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            if (result.success) {
              document.getElementById('alertTitle').textContent = 'Success';
              document.getElementById('alertMessage').textContent = 'Merchant updated successfully!';
              
              // Update the row in the table with new data
              const updatedRow = document.querySelector(`tr[data-merchant-id="${formData.merchant_id}"]`);
              if (updatedRow) {
                // Update the table data
                const cells = updatedRow.querySelectorAll('td');
                cells[1].textContent = formData.merchant_name;
                cells[2].textContent = formData.email;
                cells[3].textContent = formData.phone;
                cells[4].textContent = formData.address;
                cells[5].innerHTML = `<span class="badge ${formData.merchant_status === 'active' ? 'bg-success' : 'bg-danger'}">${formData.merchant_status}</span>`;
                
                // Update the data attribute
                const merchantData = JSON.parse(updatedRow.dataset.product);
                merchantData.merchant_name = formData.merchant_name;
                merchantData.email = formData.email;
                merchantData.phone = formData.phone;
                merchantData.address = formData.address;
                merchantData.merchant_status = formData.merchant_status;
                merchantData.updated_at = new Date().toISOString().replace('T', ' ').substr(0, 19); // Set current time as updated time
                updatedRow.dataset.product = JSON.stringify(merchantData);
              }
            } else {
              document.getElementById('alertTitle').textContent = 'Error';
              document.getElementById('alertMessage').textContent = result.message || 'Failed to update merchant. Please try again.';
            }
            alertModal.show();
          } catch (error) {
            console.error('Error updating merchant:', error);
            
            // Show error message
            const alertModal = new bootstrap.Modal(document.getElementById('alertModal'));
            document.getElementById('alertTitle').textContent = 'Error';
            document.getElementById('alertMessage').textContent = 'An error occurred while updating the merchant. Please try again.';
            alertModal.show();
            
            // Reset button state
            document.getElementById('saveProductBtn').disabled = false;
            document.getElementById('saveProductBtn').innerHTML = originalBtnText;
          }
        });
      });
    </script>
    <!--end::Script-->
  </body><!--end::Body-->
</html>
